# 📖 Kate Bot - Полное руководство системы

> **Единственный документ для понимания всей системы**

## 🎯 Обзор системы

Kate Bot - это автоматизированная система для подбора вакансий с персонализированными уведомлениями.

### Компоненты:

```
┌─────────────────────────────────────────────────────┐
│                   KATE BOT SYSTEM                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1️⃣  TELEGRAM BOT     → Команды пользователей     │
│  2️⃣  WEBAPP           → Форма подписки             │
│  3️⃣  ADMIN (Sheets)   → Управление контентом       │
│  4️⃣  MATCHING ENGINE  → Умный подбор вакансий      │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Ключевые возможности:

✅ **Персонализация** - каждый пользователь получает СВОИ вакансии  
✅ **Автоматизация** - всё работает без вашего участия  
✅ **Админка без кода** - управление через Google Таблицы  
✅ **Умный подбор** - matching через систему тегов  

---

## 📋 Быстрый старт

```bash
# 1. Проверить конфигурацию
npm run check-env

# 2. Проверить базу данных
npm run check-db

# 3. Запустить систему
npm run dev-full

# 4. Открыть WebApp
http://localhost:3001/webapp/
```

---

## 📊 FLOW #1: Управление вакансиями

### 🎨 Создание и публикация вакансии

```
1. АДМИН заполняет Google Таблицу (Вакансии)
   ├─ Название, описание, категория
   ├─ Требования, зарплата
   └─ Теги (React, Frontend, Middle)

2. АВТОСИНХРОНИЗАЦИЯ (каждые 30 мин или webhook)
   ├─ Скрипт: src/services/supabase/syncSheetsSupabase.js
   ├─ Google Sheets → читает данные
   ├─ Supabase → сохраняет в таблицу vacancies
   └─ Логи: "✅ Синхронизировано X вакансий"

3. БАЗА ДАННЫХ (Supabase)
   ├─ Таблица: vacancies
   ├─ Автоматически создаются теги: vacancy_tags
   └─ Обновляется справочник: tags

4. ПОИСК ПОДХОДЯЩИХ ПОЛЬЗОВАТЕЛЕЙ
   ├─ Система сравнивает теги вакансии с предпочтениями пользователей
   ├─ Функция: findMatchingUsers()
   └─ user_tags ⟷ vacancy_tags → находит совпадения

5. ОТПРАВКА УВЕДОМЛЕНИЙ (каждые 2 часа)
   ├─ Система: AdvancedNotificationService
   ├─ Находит новые вакансии для каждого пользователя
   ├─ Отправляет в Telegram
   ├─ Сохраняет в таблицу: notifications
   └─ Пользователь НЕ получит одну вакансию дважды
```

**Время от создания до доставки:** ~30 минут до 2 часов

---

## 📋 FLOW #2: Подписка пользователя через WebApp

### 👤 Пользователь заполняет форму

```
1. ПОЛЬЗОВАТЕЛЬ открывает WebApp
   ├─ Telegram Bot → /subscribe → открывает WebApp
   ├─ Или прямая ссылка: http://localhost:3001/webapp/
   └─ Загружается: webapp/index.html

2. ЗАГРУЗКА ВОПРОСОВ (из БД)
   ├─ Frontend: webapp/js/config.js → loadCategoriesFromAPI()
   ├─ API Request: GET /api/questions/categories
   ├─ Backend: src/api/surveyQuestionsApi.js
   ├─ Supabase: survey_categories → читает данные
   └─ Отображает категории на шаге 2

3. ПОЛЬЗОВАТЕЛЬ ЗАПОЛНЯЕТ ФОРМУ
   ├─ Шаг 1: Имя, Email, Telegram ✅
   │  └─ Автосохранение в localStorage
   ├─ Шаг 2: Выбор категории (например: Frontend) ✅
   │  ├─ Загружаются навыки для категории
   │  ├─ API: GET /api/questions/categories/frontend/fields
   │  └─ Отображает: React, Vue, Angular...
   ├─ Шаг 3: Опыт, формат работы, GEO ✅
   │  └─ Автосохранение продолжается
   └─ Шаг 4: Резюме или ссылка ✅

4. ВАЛИДАЦИЯ (на клиенте)
   ├─ webapp/js/validation.js
   ├─ Проверка email, обязательных полей
   └─ Показ ошибок в реальном времени

5. ОТПРАВКА ФОРМЫ
   ├─ User нажимает "Завершить"
   ├─ Проверка интернета (navigator.onLine)
   ├─ Показ индикатора загрузки
   ├─ POST /api/survey/complete
   └─ Данные: { firstName, lastName, email, telegram, category, skills... }

6. ОБРАБОТКА НА СЕРВЕРЕ
   ├─ Backend: src/api/surveyApi.js
   ├─ Валидация данных
   ├─ Генерация user_id: -1759310764867 (отрицательное число)
   ├─ Формирование preferences (JSONB):
   │  {
   │    specialization: ["frontend"],
   │    technologies: ["React", "TypeScript"],
   │    experience: ["2-3 года"],
   │    work_format: ["Удалёнка"],
   │    ...
   │  }
   └─ Вызов: saveUserPreferences()

7. СОХРАНЕНИЕ В БАЗУ ДАННЫХ
   ├─ Функция: src/services/supabase/supabaseUserPreferences.js
   ├─ Supabase: INSERT в таблицу user_preferences
   ├─ Автоматически создаются user_tags на основе выбранных технологий
   └─ Логи: "✅ Предпочтения сохранены"

8. ОТВЕТ ПОЛЬЗОВАТЕЛЮ
   ├─ Success response → frontend
   ├─ Показ: "✅ Форма успешно отправлена!"
   ├─ Очистка localStorage
   └─ Закрытие WebApp (возврат в бота)
```

**Время выполнения:** 2-5 секунд

---

## 🔔 FLOW #3: Персонализированные уведомления

### 📬 Как пользователь получает релевантные вакансии

```
1. ПЛАНИРОВЩИК (каждые 2 часа)
   ├─ src/services/scheduler.js
   ├─ Cron: '0 */2 * * *'
   └─ Запускает: sendPersonalizedNotifications()

2. ПОЛУЧЕНИЕ АКТИВНЫХ ПОЛЬЗОВАТЕЛЕЙ
   ├─ Читает: user_preferences WHERE is_active = true
   └─ Получает список пользователей с их предпочтениями

3. ДЛЯ КАЖДОГО ПОЛЬЗОВАТЕЛЯ:
   
   a) Получаем теги пользователя
      ├─ Читает: user_tags WHERE user_id = X
      └─ Теги: ["React", "Frontend", "Middle", "Удаленка"]
   
   b) Ищем подходящие вакансии
      ├─ Функция: findMatchingVacancies()
      ├─ Сравнивает: user_tags ⟷ vacancy_tags
      ├─ Фильтрует: is_active = true
      └─ Исключает уже отправленные (проверка в notifications)
   
   c) Проверяем что вакансия НЕ отправлялась
      ├─ Читает: notifications WHERE user_id = X AND vacancy_id = Y
      └─ Если уже есть → пропускаем
   
   d) Отправляем уведомление в Telegram
      ├─ Формируем красивое сообщение
      ├─ Добавляем кнопки: "Откликнуться", "Детали"
      ├─ Отправляем через Telegram Bot API
      └─ Сохраняем в notifications (status: 'sent')

4. ЛОГИРОВАНИЕ
   ├─ "✅ Отправлено 5 вакансий пользователю @username"
   ├─ Уведомление админа в Telegram
   └─ Статистика: отправлено / ошибок / пользователей
```

**Частота:** Каждые 2 часа автоматически

---

## 💬 FLOW #4: Работа с Telegram ботом (UX v3.0)

### 📱 Новый упрощенный UX

**Философия:** 3 клика до отклика! ✨

```
ПОЛЬЗОВАТЕЛЬ: /start
├─ Bot: src/commands/StartCommand.js
├─ Персонализированное приветствие:
│  "👋 Привет, Иван!
│   💼 Я помогу найти вакансию мечты!
│   📊 Сейчас доступно 15 вакансий"
├─ Показывает категории: [Frontend (5)] [Backend (3)] [DevOps (2)]
└─ Ждет выбора

ПОЛЬЗОВАТЕЛЬ: Выбирает категорию (например: Frontend)
├─ Action: src/actions/VacancyActions.js → CategoryAction
├─ Показывает вакансии категории:
│  [💻 Senior React Developer]
│  [⚛️ Frontend Tech Lead]
│  [⬅️ Назад к категориям]
└─ Ждет выбора

ПОЛЬЗОВАТЕЛЬ: Выбирает вакансию
├─ Action: VacancyDetailAction
├─ Показывает подробное описание
├─ Кнопки:
│  [📝 Откликнуться на вакансию]  ← ГЛАВНАЯ КНОПКА
│  [📖 Подробное описание]
│  [⬅️ Назад]
└─ Ждет действия

ПОЛЬЗОВАТЕЛЬ: Нажимает [📝 Откликнуться]
├─ Action: ApplyToVacancyAction (НОВОЕ!)
├─ Сохраняет вакансию в сессии
├─ Показывает:
│  "✅ Отлично! Откликаемся на вакансию:
│   💻 Senior React Developer
│   
│   📄 Следующий шаг: Отправьте ваше резюме
│   
│   💡 Поддерживаются форматы:
│   • PDF (.pdf)
│   • Word (.doc, .docx)
│   • Текст (.txt)"
├─ Кнопки:
│  [🔄 Выбрать другую вакансию]
│  [❌ Отменить]
└─ Ждет файл

ПОЛЬЗОВАТЕЛЬ: Отправляет файл резюме
├─ Handler: src/handlers/document.js
├─ Парсит резюме
├─ Сохраняет в responses + Google Sheets
├─ Уведомляет админа
├─ Отвечает пользователю:
│  "🎉 Ваш отклик отправлен!
│   
│   💻 Senior React Developer
│   
│   ✅ Резюме успешно получено
│   📋 Мы рассмотрим вашу кандидатуру
│   📞 Свяжемся с вами в ближайшее время
│   
│   💡 Обычно мы отвечаем в течение 1-2 дней"
└─ Показывает: [📋 Другие вакансии]

ЕСЛИ: Пользователь отправляет текст вместо файла
├─ Handler: src/handlers/text.js
├─ Проверяет: есть ли выбранная вакансия
├─ ЕСЛИ ДА:
│  └─ "📄 Ожидаем файл резюме
│      💻 Вакансия: [название]
│      💡 Пожалуйста, прикрепите файл..."
└─ ЕСЛИ НЕТ:
   └─ "👋 Привет!
       💡 Чтобы откликнуться на вакансию:
       1. Выберите интересующую вакансию
       2. Нажмите '📝 Откликнуться'
       3. Отправьте файл резюме"
```

### 🎯 Ключевые улучшения:

1. **Дружелюбное приветствие** - с именем и счетчиком вакансий
2. **Понятная кнопка** - "Откликнуться" вместо "Выбрать"
3. **Простой flow** - 3 клика: Категория → Вакансия → Откликнуться
4. **Контекстная помощь** - разные подсказки до/после выбора вакансии
5. **Персонализация** - название вакансии в каждом сообщении

---

## 🔄 FLOW #5: Синхронизация данных

### 📊 Google Sheets → Supabase

#### **A. Вакансии (каждые 30 минут)**

```
1. ПЛАНИРОВЩИК срабатывает
   └─ Cron: '*/30 * * * *'

2. ЧТЕНИЕ GOOGLE SHEETS
   ├─ Google Sheets API
   ├─ Таблица вакансий
   ├─ Диапазон: A:I (9 колонок)
   └─ Получает строки

3. ПАРСИНГ ДАННЫХ
   ├─ Строка 1 = заголовки (пропускается)
   ├─ Строки 2+ = вакансии
   └─ Преобразование в объекты

4. СРАВНЕНИЕ С СУЩЕСТВУЮЩИМИ
   ├─ Читает: vacancies из Supabase
   ├─ Сравнивает по: title + category
   └─ Определяет: новые или обновленные

5. СОХРАНЕНИЕ В SUPABASE
   ├─ Новые → INSERT
   ├─ Обновленные → UPDATE
   └─ Старые (удалены из Sheets) → is_active = false

6. СОЗДАНИЕ ТЕГОВ
   ├─ Анализ текста вакансии
   ├─ Извлечение технологий: "React", "TypeScript"
   ├─ Сохранение в: vacancy_tags
   └─ Обновление справочника: tags

7. УВЕДОМЛЕНИЕ О НОВЫХ ВАКАНСИЯХ
   ├─ Если synced > 0
   ├─ Запускается: sendNotificationsForNewVacancies()
   └─ Отправка пользователям (смотри FLOW #3)
```

#### **B. Вопросы опроса (каждый час)**

```
1. ПЛАНИРОВЩИК срабатывает
   └─ Cron: '0 * * * *'

2. ЧТЕНИЕ GOOGLE SHEETS
   ├─ Лист "Категории": A:F
   └─ Лист "Поля": A:I

3. СИНХРОНИЗАЦИЯ КАТЕГОРИЙ
   ├─ Парсинг данных
   ├─ Upsert в: survey_categories
   └─ По ключу: category_key

4. СИНХРОНИЗАЦИЯ ПОЛЕЙ
   ├─ Парсинг данных
   ├─ Парсинг опций (строка → JSON)
   ├─ Upsert в: survey_fields
   └─ По ключу: (category_key, field_key)

5. ОБНОВЛЕНИЕ WEBAPP
   ├─ При следующей загрузке формы
   ├─ GET /api/questions/categories
   └─ Пользователь видит обновленные вопросы
```

---

## 🎯 FLOW #6: Поиск и отправка релевантных вакансий

### 🔍 Алгоритм подбора

```
1. ПОЛЬЗОВАТЕЛЬ ЗАПОЛНИЛ ФОРМУ
   ├─ Сохранено в: user_preferences
   │  {
   │    specialization: ["frontend"],
   │    technologies: ["React", "TypeScript", "Vue"],
   │    experience: ["2-3 года"],
   │    work_format: ["Удалёнка"]
   │  }
   └─ Созданы теги в: user_tags
      ├─ React (technology)
      ├─ TypeScript (technology)
      ├─ Vue (technology)
      ├─ Frontend (direction)
      ├─ Middle (experience)
      └─ Удаленка (work_type)

2. ПОЯВЛЯЕТСЯ НОВАЯ ВАКАНСИЯ
   ├─ "Frontend Developer (React, TypeScript)"
   └─ Теги: ["React", "TypeScript", "Frontend", "Middle", "Удаленка"]

3. ПЛАНИРОВЩИК ЗАПУСКАЕТ УВЕДОМЛЕНИЯ (каждые 2 часа)
   ├─ Получает всех активных пользователей
   └─ Для КАЖДОГО пользователя:

4. ПОИСК ПОДХОДЯЩИХ ВАКАНСИЙ
   ├─ SQL запрос с JOIN:
   │  SELECT v.* FROM vacancies v
   │  JOIN vacancy_tags vt ON v.id = vt.vacancy_id
   │  JOIN user_tags ut ON vt.tag_name = ut.tag_name
   │  WHERE ut.user_id = :userId
   │    AND v.is_active = true
   │    AND NOT EXISTS (
   │      SELECT 1 FROM notifications 
   │      WHERE user_id = :userId AND vacancy_id = v.id
   │    )
   │  GROUP BY v.id
   │  HAVING COUNT(DISTINCT vt.tag_name) >= 2  -- Минимум 2 совпадения
   │
   └─ Результат: список вакансий с максимальным совпадением тегов

5. РАНЖИРОВАНИЕ ПО РЕЛЕВАНТНОСТИ
   ├─ Подсчет совпавших тегов
   ├─ Сортировка: больше совпадений = выше
   └─ Топ 5 вакансий для отправки

6. ОТПРАВКА УВЕДОМЛЕНИЯ
   ├─ Формирование сообщения:
   │  "🎯 Новая вакансия для вас!
   │   💼 Frontend Developer
   │   💰 150-200k руб
   │   📍 Удаленка
   │   🛠 React, TypeScript, Vue"
   ├─ Кнопки: [Откликнуться] [Подробнее]
   ├─ Отправка в Telegram
   └─ Сохранение в: notifications
      {
        user_id: 123456789,
        vacancy_id: "uuid-123",
        status: "sent",
        sent_at: "2025-01-01T12:00:00Z"
      }

7. КЛИК ПОЛЬЗОВАТЕЛЯ: [Откликнуться]
   ├─ Action: ResponseActions.js
   ├─ Запрос контактов (если еще нет)
   ├─ Запрос резюме
   ├─ Сохранение в: responses
   └─ Уведомление админа: "Новый отклик от @username"
```

---

## 📝 FLOW #7: Управление вопросами опроса

### 🎨 Редактирование формы подписки

```
1. АДМИН ОТКРЫВАЕТ GOOGLE ТАБЛИЦУ (Вопросы)
   ├─ Лист "Категории": список специализаций
   └─ Лист "Поля": поля формы для каждой категории

2. РЕДАКТИРОВАНИЕ
   ├─ Добавляет новую категорию:
   │  sales | Sales | Продажи | 💼 | 13 | TRUE
   ├─ Добавляет поля для категории:
   │  sales | crm_tools | multiselect | CRM системы | | Salesforce, HubSpot | FALSE | FALSE | 1
   └─ Сохраняет (автоматически в Google)

3. АВТОСИНХРОНИЗАЦИЯ

   ВАРИАНТ A: Webhook (мгновенно)
   ├─ Google Apps Script → onEdit() срабатывает
   ├─ Отправка POST /webhook/sync-questions
   ├─ Через 2 секунды → данные в Supabase
   └─ Новые вопросы доступны в форме

   ВАРИАНТ B: Cron (каждый час)
   ├─ Планировщик: scheduler.js
   ├─ Cron: '0 * * * *'
   └─ Через час → данные в Supabase

4. СИНХРОНИЗАЦИЯ
   ├─ Чтение Google Sheets
   ├─ Парсинг данных
   ├─ Upsert в survey_categories
   └─ Upsert в survey_fields

5. СЛЕДУЮЩАЯ ЗАГРУЗКА WEBAPP
   ├─ Пользователь открывает форму
   ├─ GET /api/questions/categories
   ├─ Загружаются обновленные категории
   └─ Отображается новая категория "Sales" с полями!
```

---

## 📊 FLOW #8: Аналитика и статистика

### 📈 Что собирается

```
1. ОТКЛИКИ (responses)
   ├─ Кто откликнулся
   ├─ На какую вакансию
   ├─ Когда
   └─ Статус обработки

2. УВЕДОМЛЕНИЯ (notifications)
   ├─ Какие вакансии отправлены
   ├─ Каким пользователям
   ├─ Когда отправлено
   └─ Статус доставки

3. ПОДПИСКИ (user_preferences)
   ├─ Популярные специализации
   ├─ Популярные технологии
   ├─ Средний опыт пользователей
   └─ Предпочитаемый формат работы

4. ПРОСМОТР СТАТИСТИКИ
   ├─ SQL View: stats_dashboard
   ├─ SELECT * FROM stats_dashboard;
   └─ Показывает:
      • Активных вакансий
      • Всего откликов
      • Всего подписок
      • Откликов за неделю
      • Подписок за неделю
```

---

## 🔄 Полная карта данных

```
┌─────────────────┐
│ GOOGLE SHEETS   │ ← Админ редактирует
└────────┬────────┘
         │
         │ Синхронизация (30 мин / 1 час)
         │
         ▼
┌─────────────────────────────────────────────┐
│           SUPABASE DATABASE                 │
│                                             │
│  ┌─────────────┐      ┌──────────────────┐ │
│  │  Вакансии   │──────│  Теги вакансий   │ │
│  │  vacancies  │      │  vacancy_tags    │ │
│  └─────────────┘      └──────────────────┘ │
│         │                                   │
│         │                                   │
│         ▼                                   │
│  ┌─────────────┐      ┌──────────────────┐ │
│  │  Отклики    │      │  Уведомления     │ │
│  │  responses  │      │  notifications   │ │
│  └─────────────┘      └──────────────────┘ │
│                              │              │
│                              │              │
│  ┌──────────────────────────┴─────────┐   │
│  │      Предпочтения пользователей    │   │
│  │      user_preferences              │   │
│  └────────────────┬───────────────────┘   │
│                   │                        │
│                   ▼                        │
│  ┌──────────────────────────────────┐     │
│  │      Теги пользователей          │     │
│  │      user_tags                   │     │
│  └──────────────────────────────────┘     │
│                                            │
│  ┌──────────────────────────────────┐     │
│  │      Категории вопросов          │     │
│  │      survey_categories           │     │
│  └────────────────┬─────────────────┘     │
│                   │                        │
│                   ▼                        │
│  ┌──────────────────────────────────┐     │
│  │      Поля формы                  │     │
│  │      survey_fields               │     │
│  └──────────────────────────────────┘     │
└─────────────────────────────────────────────┘
         │                      │
         │                      │
         ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│  TELEGRAM BOT   │    │    WEBAPP       │
│  (команды)      │    │    (форма)      │
└─────────────────┘    └─────────────────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
              ПОЛЬЗОВАТЕЛЬ
```

---

## ⚡ Время выполнения операций

| Операция | Время | Как часто |
|----------|-------|-----------|
| Заполнение WebApp формы | 2-5 сек | По требованию |
| Сохранение в БД | 1-2 сек | При отправке формы |
| Синхронизация вакансий | 5-30 сек | Каждые 30 мин |
| Синхронизация вопросов | 2-10 сек | Каждый час |
| Поиск релевантных вакансий | 1-3 сек | Каждые 2 часа |
| Отправка уведомлений | 10-60 сек | Каждые 2 часа |
| Обработка команды бота | <1 сек | Мгновенно |

---

## 📦 Движение данных

### Откуда → Куда

```
GOOGLE SHEETS (Вакансии)
   ↓ sync (30 мин)
SUPABASE (vacancies)
   ↓ matching algorithm
TELEGRAM USERS (уведомления)
   ↓ клик [Откликнуться]
SUPABASE (responses)
   ↓ уведомление
ADMIN (Telegram)

────────────────────────────────

GOOGLE SHEETS (Вопросы)
   ↓ sync (1 час)
SUPABASE (survey_categories, survey_fields)
   ↓ API request
WEBAPP (форма)
   ↓ заполнение
SUPABASE (user_preferences)
   ↓ создание тегов
SUPABASE (user_tags)
   ↓ matching
TELEGRAM USERS (релевантные вакансии)
```

---

## 🎮 Сценарии использования

### Сценарий 1: Новый пользователь

```
1. User → Telegram → /start
2. Bot → Показывает меню
3. User → нажимает [Подписаться]
4. Bot → Открывает WebApp форму
5. User → Заполняет форму (4 шага)
6. WebApp → POST /api/survey/complete
7. Server → Сохраняет в user_preferences
8. Server → Создает user_tags
9. WebApp → "✅ Готово!" → Закрывается
10. ЧЕРЕЗ 2 ЧАСА:
11. Планировщик → Ищет вакансии для User
12. Находит 3 подходящие вакансии
13. Bot → Отправляет 3 уведомления
14. User → Видит вакансии в Telegram
15. User → Откликается
16. Bot → Сохраняет отклик в responses
17. Admin → Получает уведомление о новом отклике
```

### Сценарий 2: Добавление вакансии

```
1. Admin → Открывает Google Таблицу (Вакансии)
2. Admin → Добавляет строку:
   "Senior React Developer | ... | React, TypeScript"
3. Google → Автосохранение
4. ЧЕРЕЗ 30 МИНУТ:
5. Планировщик → Синхронизация
6. Server → Читает Google Sheets
7. Server → Находит новую вакансию
8. Server → INSERT в vacancies
9. Server → Создает vacancy_tags (React, TypeScript, Frontend)
10. Server → Ищет подходящих пользователей
11. Находит 15 пользователей с тегами React + TypeScript
12. Server → Готовит 15 уведомлений
13. ЧЕРЕЗ 2 ЧАСА (или сразу):
14. Bot → Отправляет уведомления 15 пользователям
15. Users → Получают вакансию в Telegram
```

### Сценарий 3: Изменение вопросов

```
1. Admin → Google Таблица (Вопросы)
2. Admin → Лист "Поля" → Изменяет опции поля:
   work_format | Офис, Удалёнка, Гибрид, Релокация
3. Google → Автосохранение
4. ЧЕРЕЗ 1 ЧАС (или мгновенно если webhook):
5. Планировщик → Синхронизация вопросов
6. Server → Читает Google Sheets
7. Server → UPDATE survey_fields
8. СЛЕДУЮЩИЙ ПОЛЬЗОВАТЕЛЬ:
9. User → Открывает WebApp форму
10. WebApp → GET /api/questions/categories/frontend/fields
11. Server → Читает survey_fields
12. WebApp → Отображает обновленные опции:
    [Офис] [Удалёнка] [Гибрид] [Релокация] ← Новое!
```

---

## 🔐 Безопасность данных

### Защита API

- ✅ Валидация на клиенте (WebApp)
- ✅ Валидация на сервере (API)
- ✅ CORS настроен
- ✅ Timeout для запросов (30 сек)
- ⚠️ Webhook секретный токен (опционально)

### Защита БД

- ✅ RLS отключен (для упрощения в dev)
- ⚠️ Включите в продакшне
- ✅ Индексы для производительности
- ✅ Constraints для целостности

---

## 📊 Мониторинг

### Логирование

**Все операции логируются:**
```
✅ Успешные операции
❌ Ошибки
⚠️ Предупреждения
🔄 Синхронизации
📨 Webhook'и
💾 Операции с БД
```

### Уведомления админа

**Admin получает в Telegram:**
- 🔔 Новые отклики
- ✅ Результаты синхронизации
- ❌ Критические ошибки
- 📊 Статистику уведомлений

---

## 🧪 Тестирование Flow

### Проверить весь цикл

```bash
# 1. Проверить БД
npm run check-db

# 2. Запустить систему
npm run dev-full

# 3. Открыть форму
http://localhost:3001/webapp/

# 4. Заполнить и отправить
# 5. Проверить в Supabase → user_preferences
# 6. Проверить в Supabase → user_tags
# 7. Подождать 2 часа или вызвать вручную уведомления
# 8. Проверить что пришло в Telegram
```

---

---

## 💾 БАЗА ДАННЫХ

### 9 таблиц в Supabase (subscriptions удалена)

**1. Основные таблицы:**
- `vacancies` - вакансии
- `responses` - отклики пользователей

**2. Система подписок:**
- `user_preferences` - предпочтения пользователей (JSONB)
- `notifications` - история уведомлений

**3. Система тегов:**
- `tags` - справочник тегов
- `vacancy_tags` - теги вакансий (tag_name VARCHAR)
- `user_tags` - теги пользователей (tag_name VARCHAR)

**4. Система вопросов:**
- `survey_categories` - категории формы
- `survey_fields` - поля формы

### SQL файлы для создания:

```bash
# Выполните в Supabase SQL Editor по порядку:
1. database/supabase-schema.sql       # Основные таблицы
2. database/simple-new-tables.sql     # Подписки и теги
3. database/survey-questions-schema.sql # Вопросы
```

---

## ⚙️ НАСТРОЙКА (первый раз)

### 1. Создайте .env файл

```env
# Supabase (обязательно)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key

# Сервер
WEBHOOK_PORT=3001

# Telegram Bot (обязательно)
TELEGRAM_BOT_TOKEN=your_bot_token

# Google Sheets (для админки)
GOOGLE_SHEET_ID=id_таблицы_вакансий
GOOGLE_QUESTIONS_SHEET_ID=id_таблицы_вопросов
GOOGLE_SERVICE_EMAIL=service@account.com
GOOGLE_PRIVATE_KEY=private_key
```

### 2. Создайте таблицы в Supabase

Выполните 3 SQL файла в Supabase SQL Editor (по порядку)

### 3. Создайте Google Таблицы

**Вакансии:**
- Создайте таблицу
- Колонки: Название | Описание | Эмодзи | Категория | Ссылка | Уровень | Зарплата | Требования | Преимущества | Теги

**Вопросы:**
- Создайте таблицу
- Лист "Категории": импортируйте `docs/templates/categories.csv`
- Лист "Поля": импортируйте `docs/templates/fields.csv`

### 4. Заполните данные

```bash
# Заполнить Google Таблицу вопросов из questions.json
npm run populate-questions

# Синхронизировать в Supabase
npm run sync-questions
```

### 5. Запустите систему

```bash
npm run dev-full
```

---

## 🚀 КОМАНДЫ

```bash
# Запуск
npm run dev-full              # Всё: Бот + WebApp + Планировщик
npm run dev-server            # Только WebApp (для разработки)

# Синхронизация
npm run sync                  # Вакансии: Google → Supabase
npm run sync-questions        # Вопросы: Google → Supabase
npm run populate-questions    # Заполнить Google Sheets из questions.json

# Проверка и исправление
npm run check-env             # Проверка .env
npm run check-db              # Проверка всех таблиц БД
npm run fix-tags              # Создать user_tags для существующих пользователей
```

---

## 🔧 АВТОМАТИЗАЦИЯ

При запуске `npm run dev-full` автоматически:

- 🔄 **Каждые 30 минут** - синхронизация вакансий
- 🔄 **Каждый час** - синхронизация вопросов
- 🔔 **Каждые 2 часа** - персонализированные уведомления
- ⏰ **В 9:00 и 18:00** - полная синхронизация

**Настройка расписания:** `src/services/scheduler.js`

---

## 🎯 СИСТЕМА ТЕГОВ (ключевая фича)

### Как работает matching

```
User заполняет форму:
  → technologies: ["React", "TypeScript"]
  → specialization: ["frontend"]
  → Создаются user_tags:
     { user_id, tag_name: "React" }
     { user_id, tag_name: "TypeScript" }
     { user_id, tag_name: "frontend" }

Админ добавляет вакансию с тегами: "React, TypeScript, Frontend"
  → Создаются vacancy_tags:
     { vacancy_id, tag_name: "React" }
     { vacancy_id, tag_name: "TypeScript" }
     { vacancy_id, tag_name: "Frontend" }

Планировщик (каждые 2 часа):
  → SELECT * WHERE user_tags.tag_name = vacancy_tags.tag_name
  → Совпадений: 3 из 3 = 100% релевантность
  → Отправка пользователю ✅
```

### Минимальные совпадения

- ≥ 2 совпадения → вакансия отправляется
- Сортировка по количеству совпадений (больше = выше)
- Топ 5 вакансий на пользователя

---

## 📚 Дополнительная документация

**Оставлено только необходимое:**
- `SYSTEM_FLOW.md` - 👈 **Это руководство** (главный документ)
- `QUICKSTART.md` - Быстрый старт за 5 минут
- `COMMANDS.md` - Справка по командам
- `webapp/README.md` - Документация WebApp
- `docs/DATABASE_ARCHITECTURE.md` - Структура БД
- `env.template` - Шаблон .env файла

---

## 🆘 РЕШЕНИЕ ПРОБЛЕМ

### Ошибка: "Table does not exist"

```bash
# Создайте таблицы в Supabase SQL Editor
# Выполните файлы по порядку:
database/supabase-schema.sql
database/simple-new-tables.sql
database/survey-questions-schema.sql
```

### user_tags пустые

```bash
# Исправить для существующих пользователей
npm run fix-tags
```

### Вопросы не загружаются в WebApp

```bash
# 1. Проверьте что таблицы созданы
npm run check-db

# 2. Заполните Google Таблицу
npm run populate-questions

# 3. Синхронизируйте
npm run sync-questions
```

### Уведомления не отправляются

```bash
# 1. Проверьте user_tags
npm run check-db

# 2. Если пустые - исправьте
npm run fix-tags

# 3. Проверьте vacancy_tags (должны создаваться при sync)
npm run sync
```

---

## ✅ Краткое резюме

**Вся система работает по циклу:**

1. **Admin** редактирует Google Таблицы (вакансии + вопросы)
2. **Синхронизация** переносит данные в Supabase (автоматически)
3. **Users** заполняют WebApp форму
4. **Данные** сохраняются в Supabase (предпочтения + теги)
5. **Алгоритм** находит совпадения (user_tags ⟷ vacancy_tags)
6. **Bot** отправляет релевантные вакансии
7. **Users** откликаются
8. **Admin** получает отклики

**Всё автоматизировано!** 🎉

---

**Версия:** 3.0 | **Дата:** 2025 | **Статус:** ✅ Очищено и оптимизировано

